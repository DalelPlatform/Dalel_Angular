<div class="container">
  <div *ngIf="request" class="main-request-card">
    <div class="card-gradient-border"></div>

    <div class="row g-0">
      <!-- Left Column: Request Image -->
      <div class="col-md-4">
        <div class="image-container">
          <img *ngIf="request.Image" [src]="request.Image" alt="Request Image" class="request-image" />
          <div class="image-overlay">
            <i class="fas fa-search-plus"></i>
          </div>
        </div>
      </div>

      <!-- Right Column: Request Details -->
      <div class="col-md-8">
        <div class="card-content">

          <!-- Header Section -->
          <div class="request-header">
            <div class="title-section">
              <h2 class="request-title">
                <i class="fas fa-file-alt me-2"></i>
                {{ request.Title || 'Untitled Request' }}
              </h2>
            </div>

            <div class="client-info">
              <div class="client-avatar">
                <i class="fas fa-user-circle"></i>
              </div>
              <div class="client-details">
                <h4 class="client-name">{{ clientName }}</h4>
                <span class="client-label">Client</span>
              </div>
            </div>
          </div>

          <!-- Details Grid -->
          <div class="details-grid">
            <div class="row">
              <div class="detail-item m-2">
                <div class="detail-icon category-icon">
                  <i class="fas fa-tag"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Category</span>
                  <span class="detail-value">{{ categoryName }}</span>
                </div>
              </div>

              <div class="detail-item m-2">
                <div class="detail-icon location-icon">
                  <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Address</span>
                  <span class="detail-value">{{ request.Address }}</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="detail-item m-2">
                <div class="detail-icon date-icon">
                  <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Due Date</span>
                  <span class="detail-value">{{ request.DueDate | date:'mediumDate' }}</span>
                </div>
              </div>

              <div class="detail-item m-2">
                <div class="detail-icon budget-icon">
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Budget</span>
                  <span class="detail-value budget-value">{{ request.StartPrice }} EGP</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Request Date -->
          <div class="request-date">
            <i class="far fa-clock me-2"></i>
            Posted in {{ request.Date | date:'mediumDate' }}
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Add Proposal Button -->
  <div class="proposal-actions g-2" *ngIf="isServiceProvider && !showAddProposalForm">
    <button class="btn-add-proposal" (click)="showAddProposalForm = true">
      <i class="fas fa-plus-circle me-2"></i>
      Add Proposal
    </button>
    <a routerLink="/ServiceProviderlayout/AllRequests">
    <button class="btn-Back">
      <i class="fas fa-plus-circle me-2"></i>
      Back To Requests List
    </button>
    </a>
  </div>

  <!-- Proposal Form -->
  <div *ngIf="showAddProposalForm" class="proposal-form-container">
    <div class="form-header">
      <h3>
        <i class="fas fa-paper-plane me-2"></i>
        Add Your Proposal
      </h3>
    </div>

    <form (ngSubmit)="submitProposal()" #proposalForm="ngForm" class="proposal-form">
      <div class="form-group">
        <label class="form-label">
          <i class="fas fa-edit me-2"></i>
          Proposal Details
        </label>
        <textarea class="form-control modern-input" name="description" required [(ngModel)]="newProposal.description"
          rows="4" placeholder="Write a descriptive Proposal..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">
          <i class="fas fa-money-bill-wave me-2"></i>
          Suggested Price
        </label>
        <input type="number" class="form-control modern-input" name="suggestedPrice" required
          [(ngModel)]="newProposal.suggestedPrice" placeholder="Enter your suggested price" />
      </div>

      <div class="form-actions">
        <button class="btn-submit" type="submit" [disabled]="proposalForm.invalid">
          <i class="fas fa-check-circle me-2"></i>
          Submit Proposal
        </button>
        <button class="btn-cancel" type="button" (click)="Cancle()">
          <i class="fas fa-times-circle me-2"></i>
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Proposals Section -->
  <div class="proposals-section">
    <div class="section-header">
      <h3>
        <i class="fas fa-clipboard-list me-2"></i>
        Proposals for this Request
      </h3>
    </div>

    <!-- Proposals List -->
    <div *ngIf="proposals.length > 0; else noProposals" class="proposals-grid">
      <div *ngFor="let proposal of proposals" class="proposal-card">
        <p *ngIf="!providerProfiles[proposal.ServiceProviderId]">No provider info for ID {{ proposal.ServiceProviderId }}</p>

        <!-- Provider Header -->
        <div class="proposal-header" *ngIf="providerProfiles[proposal.ServiceProviderId] as provider">
          
          <div class="provider-avatar" (click)="viewProviderDetails(provider.UserId)">
            <img [src]="provider.Image" alt="Provider Image" class="provider-image" />
            <div class="provider-status"></div>
          </div>
          <div class="provider-info">
            <h4 class="provider-name">{{ provider.UserName }}</h4>
            <div class="provider-details">
              <span class="provider-service">
                <i class="fas fa-briefcase me-1"></i>
                {{ provider.ServiceArea }}
              </span>
              <span class="provider-location">
                <i class="fas fa-map-marker-alt me-1"></i>
                {{ provider.City }}
              </span>
            </div>
            <div class="provider-price">
              <i class="fas fa-tag me-1"></i>
              {{ provider.Price }} {{ provider.PriceUnit }}
            </div>
            <div class="provider-price">
              <i class="fas fa-tag me-1"></i>
            <strong>Phone:</strong> 01144882688
            </div>
          </div>
        </div>

        <!-- Proposal Content -->
        <div class="proposal-content">
          <div class="proposal-price">
            <i class="fas fa-dollar-sign"></i>
            <span class="price-amount">{{ proposal.SuggestedPrice }}</span>
            <span class="price-currency">EGP</span>
          </div>

          <div class="proposal-description">
            <h5>
              <i class="fas fa-file-alt me-2"></i>
              Proposal Description
            </h5>
            <p>{{ proposal.Description }}</p>
          </div>

          <div class="proposal-date">
            <i class="far fa-calendar me-2"></i>
            {{ proposal.Date | date:'medium' }}
          </div>

          <!-- Action buttons for Pending proposals -->
          <div class="proposal-actions" *ngIf="isClient && proposal.Status === proposalStatus.Pending">
            <button class="btn-accept" [disabled]="isProposalAcceptDisabled(proposal)"
              (click)="openDynamicModal(proposal.Id, 'accept')">
              <i class="fas fa-check me-2"></i>
              Accept Proposal
            </button>
            <button class="btn-reject" (click)="rejectProposal(proposal.Id)">
              <i class="fas fa-times me-2"></i>
              Reject Proposal
            </button>
          </div>
          
          <!-- Action buttons for Accepted proposals -->
          <div class="proposal-actions" *ngIf="isClient && proposal.Status === proposalStatus.Accepted">
            <button class="btn-accept" (click)="openDynamicModal(proposal.Id, 'complete')">
              <i class="fas fa-check me-2"></i>
              Complete Proposal
            </button>
            <button class="btn-reject" (click)="openDynamicModal(proposal.Id, 'cancel')">
              <i class="fas fa-times me-2"></i>
              Cancel Proposal
            </button>
          </div>

          <!-- Action buttons for Completed proposals -->
          <div class="proposal-actions" *ngIf="isClient && proposal.Status === proposalStatus.Completed">
            <button class="btn-accept" *ngIf="isClient && proposal.Status === proposalStatus.Completed" (click)="openReviewModal(proposal.Id)">
              <i class="fas fa-star me-2"></i>
              Leave A Review
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- No Proposals Message -->
    <ng-template #noProposals>
      <div class="no-proposals">
        <div class="no-proposals-icon">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <h4>There are No Proposals yet</h4>
        <p>this request has no proposals yet</p>
      </div>
    </ng-template>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content modern-modal">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">
            <i class="fas fa-check-circle me-2"></i>
            {{ modalTitle }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="close"></button>
        </div>
        <div class="modal-body">
          <div class="confirmation-message">
            <i class="fas fa-question-circle"></i>
            <h4>{{ modalMessage }}</h4>
            <p>The Service Provider Will Be Notified</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>
            Cancel
          </button>
          <button type="button" class="btn btn-success" (click)="confirmModalAction()">
            <i class="fas fa-check me-2"></i>
            Confirm
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Information Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content modern-modal">
        <div class="modal-header">
          <h5 class="modal-title" id="infoModalLabel">
            <i class="fas fa-info-circle me-2"></i>
            Notice
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- dynamic message will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
            <i class="fas fa-check me-2"></i> OK
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content modern-modal">
        <div class="modal-header">
          <h5 class="modal-title" id="reviewModalLabel">
            <i class="fas fa-star me-2"></i> Leave a Review
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form (ngSubmit)="submitReview()" #reviewForm="ngForm">
          <div class="modal-body">
            <div class="form-group">
              <label>Rating</label>
              <select class="form-control" required [(ngModel)]="reviewModel.Rating" name="rating">
                <option [ngValue]="null" disabled selected>Choose Rating</option>
                <option *ngFor="let r of [1,2,3,4,5]" [value]="r">{{r}} Stars</option>
              </select>
            </div>
            <div class="form-group mt-3">
              <label>Review</label>
              <textarea class="form-control" required [(ngModel)]="reviewModel.Review" name="review" maxlength="500"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success" [disabled]="reviewForm.invalid">Submit Review</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>